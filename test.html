<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NeoMindzLive — IQ Test</title>
  <link rel="stylesheet" href="./css/test.css" />
</head>
<body class="page">
  <header class="topbar">
    <div class="topbar-inner">
      <a class="brand" href="./en.html">
        <img class="brand-logo" src="./assets/logo/logo.png" alt="NeoMindzLive" onerror="this.style.display='none'">
        <span class="brand-name">NeoMindzLive</span>
      </a>
      <div class="topbar-right">
        <a class="ghost" href="./en.html">Back</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="card-head">
        <div>
          <div class="kicker">Hybrid test</div>
          <h1 class="title">Answer the questions</h1>
          <p class="sub">Adaptive → Classic → Speed. Result will be shown after unlock.</p>
        </div>

        <div class="hud">
          <div class="pill">
            <span class="pill-label">Stage</span>
            <strong id="stageName">—</strong>
          </div>
          <div class="pill">
            <span class="pill-label">Q</span>
            <strong><span id="qIndex">0</span></strong>
          </div>
          <div class="pill timer">
            <span class="pill-label">Time</span>
            <strong id="timer">—</strong>
          </div>
        </div>
      </div>

      <div class="progress">
        <div id="bar" class="bar"></div>
      </div>

      <div class="question">
        <div id="prompt" class="prompt">Loading…</div>

        <div id="choices" class="choices"></div>

        <div class="foot">
          <div class="note" id="note">Tip: choose the best option.</div>
          <button id="skipBtn" class="ghost" type="button">Skip</button>
        </div>
      </div>
    </section>
  </main>

<script>
(() => {
  // ===== CONFIG =====
  const API = (window.NEO_API_BASE || "http://127.0.0.1:8000").replace(/\/$/, "");

  // ===== USER ID (unified) =====
  const KEY = "neo_user_id";
  if (!localStorage.getItem(KEY)) localStorage.setItem(KEY, "user_" + crypto.randomUUID());
  const USER_ID = localStorage.getItem(KEY);

  const elStage = document.getElementById("stageName");
  const elQIndex = document.getElementById("qIndex");
  const elTimer = document.getElementById("timer");
  const elPrompt = document.getElementById("prompt");
  const elChoices = document.getElementById("choices");
  const elBar = document.getElementById("bar");
  const skipBtn = document.getElementById("skipBtn");

  let sessionId = null;
  let currentQuestion = null;
  let secondsLeft = 0;
  let tick = null;
  let startedAt = 0;

  // Backend stage_limits bilan MOS:
  const STAGE_TOTAL = { adaptive: 12, classic: 18, speed: 20 };

  function stageLabel(s){
    if (s === "adaptive") return "Adaptive";
    if (s === "classic") return "Classic";
    if (s === "speed") return "Speed";
    return s || "—";
  }

  function clearTimer(){
    if (tick) clearInterval(tick);
    tick = null;
  }

  function startTimer(sec){
    clearTimer();
    secondsLeft = Math.max(1, Number(sec || 30));
    startedAt = Date.now();
    renderTimer();
    tick = setInterval(() => {
      secondsLeft -= 1;
      renderTimer();
      if (secondsLeft <= 0) {
        clearTimer();
        // vaqt tugasa avtomatik -1 yuboramiz (always wrong)
        submitAnswer(-1, true);
      }
    }, 1000);
  }

  function renderTimer(){
    const m = String(Math.floor(secondsLeft / 60)).padStart(2,"0");
    const s = String(secondsLeft % 60).padStart(2,"0");
    elTimer.textContent = `${m}:${s}`;
  }

  function setProgress(stage, qIndex){
    const total = STAGE_TOTAL[stage] || 10;
    const p = Math.min(100, Math.max(0, ((qIndex || 1) - 1) / total * 100));
    elBar.style.width = p + "%";
  }

  async function api(path, opts={}){
    const res = await fetch(API + path, {
      ...opts,
      headers: {
        "Content-Type": "application/json",
        "X-User-Id": USER_ID,
        ...(opts.headers || {})
      }
    });
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch(e) {}

    if (!res.ok) {
      const msg = (data && (data.detail || data.message))
        ? (data.detail || data.message)
        : (text || "Request failed");
      const err = new Error(msg);
      err.status = res.status;
      err.raw = text;
      throw err;
    }
    return data;
  }

  async function start(){
    const data = await api("/api/test/start", { method:"POST", body: "{}" });
    sessionId = data.session_id;
    renderQuestion(data);
  }

  function renderQuestion(data){
    const q = data.question;
    currentQuestion = q;

    elStage.textContent = stageLabel(data.stage);
    elQIndex.textContent = `${data.question_index}/${STAGE_TOTAL[data.stage] || "?"}`;
    elPrompt.textContent = q.prompt || "—";

    setProgress(data.stage, data.question_index);

    elChoices.innerHTML = "";

    const choices = q.choices || q.options || [];
    if (!choices.length) {
      elChoices.innerHTML = `<div class="note">No choices found for this question.</div>`;
    }

    choices.forEach((c, idx) => {
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.type = "button";
      btn.innerHTML = `<span class="key">${String.fromCharCode(65+idx)}</span><span class="txt">${c}</span>`;
      btn.addEventListener("click", () => submitAnswer(idx, false));
      elChoices.appendChild(btn);
    });

    startTimer(q.time_limit_sec || 30);
  }

  async function submitAnswer(chosenIndex, isAuto){
    if (!sessionId || !currentQuestion) return;

    // double clickdan saqlash
    [...elChoices.querySelectorAll("button")].forEach(b => b.disabled = true);
    skipBtn.disabled = true;

    const spent = Math.max(0, Math.round((Date.now() - startedAt)/1000));
    clearTimer();

    try {
      const payload = {
        session_id: sessionId,
        question_id: currentQuestion.id,
        chosen_index: Number(chosenIndex),
        time_spent_sec: spent
      };

      const resp = await api("/api/test/answer", { method:"POST", body: JSON.stringify(payload) });

      if (resp.finished) {
        // Test tugadi -> natija sahifasiga
        window.location.href = `./result.html?session_id=${encodeURIComponent(resp.session_id || sessionId)}`;
        return;
      }

      renderQuestion(resp);

    } catch(err){
      alert(err.message || "Error");
      // qayta yoqib qo'yamiz
      [...elChoices.querySelectorAll("button")].forEach(b => b.disabled = false);
      skipBtn.disabled = false;
      startTimer(currentQuestion?.time_limit_sec || 30);
    }
  }

  // skip ham -1 yuboradi
  skipBtn.addEventListener("click", () => submitAnswer(-1, true));

  // start
  start().catch(e => alert((e && e.message) ? e.message : "Failed to start test"));
})();
</script>
</body>
</html>
